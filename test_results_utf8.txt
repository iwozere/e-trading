============================= test session starts =============================
platform win32 -- Python 3.13.1, pytest-8.4.1, pluggy-1.5.0
rootdir: C:\dev\cursor\e-trading
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.0.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 21 items

src\common\sentiments\tests\test_async_stocktwits.py ...F...FFFFF....FF. [ 90%]
..                                                                       [100%]

================================== FAILURES ===================================
________ TestAsyncStocktwitsAdapter.test_fetch_messages_malformed_data ________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E94A060>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456E949350>

    @pytest.mark.asyncio
    async def test_fetch_messages_malformed_data(self, adapter):
        """Test handling of malformed message data."""
        malformed_response = {
            "messages": [
                {"id": 123, "body": "Valid message"},  # Valid
                {"body": "Missing ID"},  # Invalid - no ID
                {"id": 124},  # Valid but missing body
                None,  # Invalid - null message
            ]
        }
    
        with patch.object(adapter, '_get_with_retry', new_callable=AsyncMock) as mock_get:
            mock_get.return_value = malformed_response
    
>           messages = await adapter.fetch_messages("AAPL")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src\common\sentiments\tests\test_async_stocktwits.py:135: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456E949350>
ticker = 'AAPL', since_ts = None, limit = 200

    async def fetch_messages(self, ticker: str, since_ts: Optional[int] = None, limit: int = 200) -> List[Dict[str, Any]]:
        """
        Fetch individual messages for a ticker from StockTwits.
    
        Args:
            ticker: Stock ticker symbol
            since_ts: Unix timestamp to fetch messages since (not directly supported by StockTwits API)
            limit: Maximum number of messages to fetch
    
        Returns:
            List of normalized message dictionaries
        """
        if not ticker or not ticker.strip():
            raise ValueError("Ticker cannot be empty")
    
        symbol = ticker.upper().strip()
        msgs: List[Dict[str, Any]] = []
        path = f"/streams/symbol/{symbol}.json"
        params = {"limit": min(30, limit)}  # StockTwits API limit is 30 per request
    
        try:
            payload = await self._get_with_retry(path, params=params)
            if not payload:
                _logger.warning("No payload received for ticker %s", symbol)
                return []
    
            page = payload.get("messages", [])
            if not page:
                _logger.debug("No messages found for ticker %s", symbol)
                return []
    
            for m in page:
                try:
                    # Validate required fields
>                   if not m.get("id"):
                           ^^^^^
E                   AttributeError: 'NoneType' object has no attribute 'get'

src\common\sentiments\adapters\async_stocktwits.py:214: AttributeError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,044 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,045 - DEBUG - Skipping message without ID for ticker AAPL
2026-01-05 22:04:39,045 - ERROR - Failed to fetch messages for ticker AAPL: 'NoneType' object has no attribute 'get'
------------------------------ Captured log call ------------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:215 Skipping message without ID for ticker AAPL
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:248 Failed to fetch messages for ticker AAPL: 'NoneType' object has no attribute 'get'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,163 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
___________ TestAsyncStocktwitsAdapter.test_get_with_retry_success ____________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E989750>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456E992580>

    @pytest.mark.asyncio
    async def test_get_with_retry_success(self, adapter):
        """Test successful HTTP request with retry logic."""
        mock_response = Mock()
        mock_response.status = 200
        mock_response.json = AsyncMock(return_value={"test": "data"})
        mock_response.raise_for_status = Mock()
        mock_response.request_info = Mock()
        mock_response.history = []
    
        mock_context_manager = AsyncMock()
        mock_context_manager.__aenter__.return_value = mock_response
        mock_context_manager.__aexit__.return_value = None
    
        import aiohttp
        mock_session = Mock(spec=aiohttp.ClientSession)
        mock_session.get = Mock(return_value=mock_context_manager)
        adapter._session = mock_session
    
        result = await adapter._get_with_retry("/test", params={"param": "value"})
    
>       assert result == {"test": "data"}
E       AssertionError: assert None == {'test': 'data'}

src\common\sentiments\tests\test_async_stocktwits.py:219: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,188 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,246 - WARNING - Stocktwits status 403 for https://api.stocktwits.com/api/2/test
2026-01-05 22:04:39,246 - ERROR - Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test?param=value' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
2026-01-05 22:04:39,246 - ERROR - Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test?param=value'
------------------------------ Captured log call ------------------------------
WARNING  src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:98 Stocktwits status 403 for https://api.stocktwits.com/api/2/test
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:104 Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test?param=value' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:150 Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test?param=value'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,257 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
__________ TestAsyncStocktwitsAdapter.test_get_with_retry_rate_limit __________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E989950>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456E98B050>

    @pytest.mark.asyncio
    async def test_get_with_retry_rate_limit(self, adapter):
        """Test handling of rate limit (429) responses."""
        # First call returns 429, second call succeeds
        mock_response_429 = Mock()
        mock_response_429.status = 429
        mock_response_429.headers = {'retry-after': '0.1'}  # Shorter delay for testing
        mock_response_429.request_info = Mock()
        mock_response_429.history = []
    
        mock_response_200 = Mock()
        mock_response_200.status = 200
        mock_response_200.json = AsyncMock(return_value={"success": True})
        mock_response_200.raise_for_status = Mock()
        mock_response_200.request_info = Mock()
        mock_response_200.history = []
    
        mock_context_manager_429 = AsyncMock()
        mock_context_manager_429.__aenter__.return_value = mock_response_429
        mock_context_manager_429.__aexit__.return_value = None
    
        mock_context_manager_200 = AsyncMock()
        mock_context_manager_200.__aenter__.return_value = mock_response_200
        mock_context_manager_200.__aexit__.return_value = None
    
        import aiohttp
        mock_session = Mock(spec=aiohttp.ClientSession)
        mock_session.get = Mock(side_effect=[mock_context_manager_429, mock_context_manager_200])
        adapter._session = mock_session
    
        result = await adapter._get_with_retry("/test")
    
>       assert result == {"success": True}
E       AssertionError: assert None == {'success': True}

src\common\sentiments\tests\test_async_stocktwits.py:254: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,260 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,315 - WARNING - Stocktwits status 403 for https://api.stocktwits.com/api/2/test
2026-01-05 22:04:39,319 - ERROR - Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
2026-01-05 22:04:39,319 - ERROR - Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
------------------------------ Captured log call ------------------------------
WARNING  src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:98 Stocktwits status 403 for https://api.stocktwits.com/api/2/test
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:104 Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:150 Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,329 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
_________ TestAsyncStocktwitsAdapter.test_get_with_retry_server_error _________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E965C70>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456E989E50>

    @pytest.mark.asyncio
    async def test_get_with_retry_server_error(self, adapter):
        """Test handling of server errors (5xx)."""
        mock_response_500 = Mock()
        mock_response_500.status = 500
        mock_response_500.request_info = Mock()
        mock_response_500.history = []
    
        mock_response_200 = Mock()
        mock_response_200.status = 200
        mock_response_200.json = AsyncMock(return_value={"recovered": True})
        mock_response_200.raise_for_status = Mock()
    
        mock_session = AsyncMock()
        mock_session.get.return_value.__aenter__.side_effect = [
            mock_response_500, mock_response_200
        ]
        adapter._session = mock_session
    
        result = await adapter._get_with_retry("/test")
    
>       assert result == {"recovered": True}
E       AssertionError: assert None == {'recovered': True}

src\common\sentiments\tests\test_async_stocktwits.py:279: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,333 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,376 - WARNING - Stocktwits status 403 for https://api.stocktwits.com/api/2/test
2026-01-05 22:04:39,376 - ERROR - Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
2026-01-05 22:04:39,376 - ERROR - Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
------------------------------ Captured log call ------------------------------
WARNING  src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:98 Stocktwits status 403 for https://api.stocktwits.com/api/2/test
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:104 Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:150 Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,387 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
_____ TestAsyncStocktwitsAdapter.test_get_with_retry_max_retries_exceeded _____

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E965E50>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EA55130>

    @pytest.mark.asyncio
    async def test_get_with_retry_max_retries_exceeded(self, adapter):
        """Test behavior when max retries are exceeded."""
        mock_response = Mock()
        mock_response.status = 500
        mock_response.request_info = Mock()
        mock_response.history = []
    
        mock_session = AsyncMock()
        mock_session.get.return_value.__aenter__.return_value = mock_response
        adapter._session = mock_session
    
        result = await adapter._get_with_retry("/test")
    
        assert result is None
>       assert adapter._health_info.status == AdapterStatus.DEGRADED
E       assert <AdapterStatus.HEALTHY: 'healthy'> == <AdapterStatus.DEGRADED: 'degraded'>
E        +  where <AdapterStatus.HEALTHY: 'healthy'> = AdapterHealthInfo(status=<AdapterStatus.HEALTHY: 'healthy'>, last_success=None, last_failure=datetime.datetime(2026, 1...th unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'", response_time_ms=None).status
E        +    where AdapterHealthInfo(status=<AdapterStatus.HEALTHY: 'healthy'>, last_success=None, last_failure=datetime.datetime(2026, 1...th unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'", response_time_ms=None) = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EA55130>._health_info
E        +  and   <AdapterStatus.DEGRADED: 'degraded'> = AdapterStatus.DEGRADED

src\common\sentiments\tests\test_async_stocktwits.py:296: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,390 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,430 - WARNING - Stocktwits status 403 for https://api.stocktwits.com/api/2/test
2026-01-05 22:04:39,430 - ERROR - Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
2026-01-05 22:04:39,431 - ERROR - Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
------------------------------ Captured log call ------------------------------
WARNING  src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:98 Stocktwits status 403 for https://api.stocktwits.com/api/2/test
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:104 Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:150 Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,441 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
___________ TestAsyncStocktwitsAdapter.test_get_with_retry_timeout ____________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E963A10>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EA55E50>

    @pytest.mark.asyncio
    async def test_get_with_retry_timeout(self, adapter):
        """Test handling of timeout errors."""
        mock_session = AsyncMock()
        mock_session.get.side_effect = asyncio.TimeoutError("Request timeout")
        adapter._session = mock_session
    
        result = await adapter._get_with_retry("/test")
    
        assert result is None
>       assert adapter._health_info.status == AdapterStatus.DEGRADED
E       assert <AdapterStatus.HEALTHY: 'healthy'> == <AdapterStatus.DEGRADED: 'degraded'>
E        +  where <AdapterStatus.HEALTHY: 'healthy'> = AdapterHealthInfo(status=<AdapterStatus.HEALTHY: 'healthy'>, last_success=None, last_failure=datetime.datetime(2026, 1...th unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'", response_time_ms=None).status
E        +    where AdapterHealthInfo(status=<AdapterStatus.HEALTHY: 'healthy'>, last_success=None, last_failure=datetime.datetime(2026, 1...th unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'", response_time_ms=None) = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EA55E50>._health_info
E        +  and   <AdapterStatus.DEGRADED: 'degraded'> = AdapterStatus.DEGRADED

src\common\sentiments\tests\test_async_stocktwits.py:310: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,444 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,482 - WARNING - Stocktwits status 403 for https://api.stocktwits.com/api/2/test
2026-01-05 22:04:39,483 - ERROR - Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
2026-01-05 22:04:39,483 - ERROR - Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
------------------------------ Captured log call ------------------------------
WARNING  src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:98 Stocktwits status 403 for https://api.stocktwits.com/api/2/test
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:104 Stocktwits failed to parse JSON from https://api.stocktwits.com/api/2/test: 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test' (Body: <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta nam)
ERROR    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:150 Stocktwits request failed after 2 attempts: https://api.stocktwits.com/api/2/test 403, message='Attempt to decode JSON with unexpected mimetype: text/html; charset=utf-8', url='https://api.stocktwits.com/api/2/test'
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,493 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
____________ TestAsyncStocktwitsAdapter.test_concurrency_limiting _____________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E8AEBA0>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EAE47D0>

    @pytest.mark.asyncio
    async def test_concurrency_limiting(self, adapter):
        """Test that concurrency is properly limited."""
        # Create adapter with concurrency limit of 1
        limited_adapter = AsyncStocktwitsAdapter(concurrency=1, rate_limit_delay=0.01)
    
        try:
            call_times = []
    
            async def mock_slow_request(*args, **kwargs):
                call_times.append(asyncio.get_event_loop().time())
                await asyncio.sleep(0.1)  # Simulate slow request
                return {"messages": []}
    
            with patch.object(limited_adapter, '_get_with_retry', new_callable=AsyncMock) as mock_get:
                mock_get.side_effect = mock_slow_request
    
                # Start multiple concurrent requests
                tasks = [
                    limited_adapter.fetch_messages("AAPL"),
                    limited_adapter.fetch_messages("TSLA"),
                    limited_adapter.fetch_messages("MSFT")
                ]
    
                await asyncio.gather(*tasks)
    
                # Verify requests were serialized (not truly concurrent)
                assert len(call_times) == 3
                # With concurrency=1, requests should be serialized
                time_diffs = [call_times[i+1] - call_times[i] for i in range(len(call_times)-1)]
>               assert all(diff >= 0.05 for diff in time_diffs)  # Should have gaps due to serialization
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E               assert False
E                +  where False = all(<generator object TestAsyncStocktwitsAdapter.test_concurrency_limiting.<locals>.<genexpr> at 0x000002456EB6C2B0>)

src\common\sentiments\tests\test_async_stocktwits.py:400: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,514 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,515 - DEBUG - Loaded 63 positive and 73 negative keywords
2026-01-05 22:04:39,619 - DEBUG - No messages found for ticker AAPL
2026-01-05 22:04:39,620 - DEBUG - No messages found for ticker TSLA
2026-01-05 22:04:39,620 - DEBUG - No messages found for ticker MSFT
2026-01-05 22:04:39,620 - DEBUG - StockTwits adapter closed successfully
------------------------------ Captured log call ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:208 No messages found for ticker AAPL
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:208 No messages found for ticker TSLA
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:208 No messages found for ticker MSFT
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,630 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
________________ TestAsyncStocktwitsAdapter.test_close_cleanup ________________

self = <src.common.sentiments.tests.test_async_stocktwits.TestAsyncStocktwitsAdapter object at 0x000002456E8AED00>
adapter = <src.common.sentiments.adapters.async_stocktwits.AsyncStocktwitsAdapter object at 0x000002456EAE4D10>

    @pytest.mark.asyncio
    async def test_close_cleanup(self, adapter):
        """Test proper resource cleanup on close."""
        # Set up a session
        adapter._session = Mock(spec=aiohttp.ClientSession)
        adapter._session.close = AsyncMock()
    
        await adapter.close()
    
        # Verify session was closed
>       adapter._session.close.assert_called_once()

src\common\sentiments\tests\test_async_stocktwits.py:415: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <AsyncMock name='mock.close' id='2497232530000'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'close' to have been called once. Called 0 times.

C:\Users\akoss\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:956: AssertionError
---------------------------- Captured stderr setup ----------------------------
2026-01-05 22:04:39,633 - DEBUG - Loaded 63 positive and 73 negative keywords
----------------------------- Captured log setup ------------------------------
DEBUG    src.common.sentiments.processing.heuristic_analyzer:heuristic_analyzer.py:96 Loaded 63 positive and 73 negative keywords
---------------------------- Captured stderr call -----------------------------
2026-01-05 22:04:39,635 - DEBUG - StockTwits adapter closed successfully
------------------------------ Captured log call ------------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
-------------------------- Captured stderr teardown ---------------------------
2026-01-05 22:04:39,694 - DEBUG - StockTwits adapter closed successfully
---------------------------- Captured log teardown ----------------------------
DEBUG    src.common.sentiments.adapters.async_stocktwits:async_stocktwits.py:326 StockTwits adapter closed successfully
=========================== short test summary info ===========================
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_fetch_messages_malformed_data
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_get_with_retry_success
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_get_with_retry_rate_limit
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_get_with_retry_server_error
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_get_with_retry_max_retries_exceeded
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_get_with_retry_timeout
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_concurrency_limiting
FAILED src/common/sentiments/tests/test_async_stocktwits.py::TestAsyncStocktwitsAdapter::test_close_cleanup
======================== 8 failed, 13 passed in 1.17s =========================
